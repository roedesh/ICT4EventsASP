--THE PROCEDURE TO CREATE A RESERVATION AND A USER AND CONNECT THEM
CREATE OR REPLACE PROCEDURE InschrijvingPlaatsen
(
P_VOORNAAM IN VARCHAR2,
P_TUSSENVOEGSEL IN VARCHAR2 DEFAULT NULL,
P_ACHTERNAAM IN VARCHAR2,
P_STRAAT IN VARCHAR2,
P_HUISNUMMER IN VARCHAR2,
P_WOONPLAATS IN VARCHAR2,
P_BANKNR IN VARCHAR2,
P_DATUMSTART IN VARCHAR2,
P_DATUMEINDE IN VARCHAR2,
P_BETAAL IN NUMBER DEFAULT 0,
OP_ERROROCCURANCE OUT BOOLEAN
)
IS
V_VOORNAAM VARCHAR2(255);
V_ACHTERNAAM VARCHAR2(255);
V_TUSSENVOEGSEL VARCHAR2(255);
V_STRAAT VARCHAR2(255);
V_HUISNUMMER VARCHAR2(255);
V_WOONPLAATS VARCHAR2(255);
V_BANKNR VARCHAR2(255);
V_DATUMSTART DATE;
V_DATUMEINDE DATE;
V_MAX1 NUMBER(20);
V_MAX NUMBER(20);
V_BETAAL VARCHAR2(1);
V_COUNTER NUMBER(20);
BEGIN
OP_ERROROCCURANCE := false;
V_BANKNR := UPPER(P_BANKNR);
V_VOORNAAM := INITCAP(P_VOORNAAM);
V_ACHTERNAAM := INITCAP(P_ACHTERNAAM);
V_TUSSENVOEGSEL := LOWER(P_TUSSENVOEGSEL);
V_STRAAT := INITCAP(P_STRAAT);
V_WOONPLAATS := INITCAP(P_WOONPLAATS);
V_HUISNUMMER := LOWER(P_HUISNUMMER);
V_DATUMSTART := REPLACE(P_DATUMSTART, ' ');
V_DATUMSTART := REPLACE(V_DATUMSTART, '-');
V_DATUMSTART := REPLACE(V_DATUMSTART, '/');
V_DATUMSTART := REPLACE(V_DATUMSTART, '|');
V_DATUMEINDE := REPLACE(P_DATUMEINDE, ' ');
V_DATUMEINDE := REPLACE(V_DATUMEINDE, '-');
V_DATUMEINDE := REPLACE(V_DATUMEINDE, '/');
V_DATUMEINDE := REPLACE(V_DATUMEINDE, '|');
V_DATUMSTART := TO_DATE(V_DATUMSTART, 'yy-mm-dd');
V_DATUMEINDE := TO_DATE(V_DATUMEINDE, 'yy-mm-dd');
SELECT COUNT(ID) INTO V_COUNTER FROM PERSOON;
IF V_COUNTER != 0 THEN 
SELECT MAX(ID) INTO V_MAX FROM PERSOON;
V_MAX := V_MAX + 1;
ELSIF V_COUNTER = 0 THEN
V_MAX := 1;
END IF;
INSERT INTO PERSOON VALUES (V_MAX,V_VOORNAAM,V_TUSSENVOEGSEL,V_ACHTERNAAM,V_STRAAT,V_HUISNUMMER,V_WOONPLAATS,V_BANKNR);
COMMIT;
SELECT COUNT(ID) INTO V_COUNTER FROM RESERVERING;
IF V_COUNTER != 0 THEN 
SELECT MAX(ID) INTO V_MAX1 FROM RESERVERING;
V_MAX1 := V_MAX1 + 1;
ELSIF V_COUNTER = 0 THEN
V_MAX1 := 1;
END IF;
INSERT INTO RESERVERING VALUES(V_MAX1, V_MAX, V_DATUMSTART, V_DATUMEINDE, P_BETAAL);
COMMIT;
EXCEPTION
WHEN NO_DATA_FOUND THEN
OP_ERROROCCURANCE := true;
END;
/
DECLARE
V_ERRORCODE BOOLEAN;
BEGIN
InschrijvingPlaatsen('Berry','','Verschueren','Goudbergseweg','11','Strijbeek','NL33RABO0178902284','16-06-2015','18-06-2015',0,V_ERRORCODE);
END;
/
CREATE OR REPLACE PROCEDURE DELETEUNACTIVE
IS
BEGIN
DELETE FROM ACCOUNT WHERE GEACTIVEERD = 0;
END;
/
BEGIN
DBMS_SCHEDULER.CREATE_JOB (
   job_name             => 'Delete_Not_Activated_Accounts', 
   job_type             => 'STORED_PROCEDURE',
   job_action           => 'DELETEUNACTIVE',
   repeat_interval      => 'FREQ=MINUTELY;BYMINUTE=5',
   comments             => 'Deletes all the accounts that are not activated within 5 minutes');
END;